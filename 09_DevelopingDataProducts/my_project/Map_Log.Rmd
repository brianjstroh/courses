---
title: "Map Log"
author: "Brian Stroh"
date: "October 29, 2018"
output: html_document
runtime: shiny
---

<style type="text/css">
.main-container {
      max-width: 940px;
      margin-left: 0px;
      margin-right: auto;
}
code {
      color: inherit;
      background-color: rgba(0, 0, 0, 0.04);
}
img {
      max-width:100%;
      height: 100%;
}
.tabbed-pane {
      padding-top: 12px;
}
.html-widget {
      margin-bottom: 20px;
}
button.code-folding-btn:focus {
      outline: none;
}

</style>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(shiny)
library(leaflet)
library(dplyr)
library(data.table)
library(urltools)

getLatLong<- function(address){
      if(address$street !="-" && address$city !="-" && address$state !="-" && address$zip !="-"){
            findme<-as.character(paste(address$street,address$city,paste(address$state,paste0(address$zip,"\",null,"),sep=" "),sep=", "))
            address$street<-gsub(" ","+",address$street)
            lookupURL<-paste0("https://www.google.com/maps/place/",address$street,",+",address$city,",+",address$state,"+",address$zip,"/")
      }else if(address$street !="-" && address$city !="-" && address$state !="-"){
            findme<-as.character(paste(address$street,address$city,paste0(address$state,"\",null,"),sep=", "))
            address$street<-gsub(" ","+",address$street)
            lookupURL<-paste0("https://www.google.com/maps/place/",address$street,",+",address$city,",+",address$state,"/")
      }else if(address$city !="-" && address$state !="-"){
            findme<-as.character(paste(address$city,paste0(address$state,"\",null,"),sep=", "))
            lookupURL<-paste0("https://www.google.com/maps/place/",address$city,",+",address$state,"/")
      }else if(address$street !="-"){
            findme<-as.character(paste0(address$street,"\",null,"))
            address$street<-gsub(" ","+",address$street)
            lookupURL<-paste0("https://www.google.com/maps/place/",address$street,"/")
      }else if(address$city !="-"){
            findme<-as.character(paste0(address$city,"\",null,"))
            lookupURL<-paste0("https://www.google.com/maps/place/",address$city,"/")
      }
      download.file(lookupURL,destfile = "rawtext.txt")
      rawtext<-readChar("rawtext.txt", file.info("rawtext.txt")$size)
      pos = regexpr(findme, rawtext)
      newtext<-substring(rawtext,pos+nchar(findme)+11,pos+nchar(findme)+70)
      return(as.numeric(unlist(strsplit(substring(newtext,1,regexpr("]",newtext)-1),","))))
      
      
}

patch_url<-function(my_url){
      ifelse(
            is.na(url_parse(my_url)$scheme), #check if url has something like 'http://'
            my_url<-paste0("http://",my_url), #if not, then add it
            my_url)
}



```


```{r shiny, echo = FALSE, fig.pos='left'}

ui <- fluidPage(pageWithSidebar(
            headerPanel(""),
            sidebarPanel(
                    textInput("label","Address Label","-"),
                    textInput("street","Street Address","-"),
                    textInput("city","City","-"),
                    textInput("state","State","-"),
                    textInput("zip","Zip Code","-"),
                    textInput("url","HyperLink","-"),
                    fileInput("icon", "Choose Pictures",
                              multiple = FALSE,
                              accept = c("image/gif",
                                          "image/jpeg",
                                          "image/png",
                                          "image/tiff",
                                          "image/svg+xml")),
                    actionButton("add", "Add Location")
              ),
            mainPanel(
                  tabsetPanel(
                        tabPanel("Current Logged Locations",
                                leafletOutput("map")
                        ),
                        tabPanel("Logged Location Table",
                                dataTableOutput("address_table")
                        )
                  )
            )
))
server <- function(input, output, session) {
      my_addresses <- reactiveValues()
      my_addresses$data <- data.table(label = rep("-",10),
                                      street = rep("-",10),
                                      city = rep("-",10),
                                      state = rep("-",10),
                                      zip = rep("-",10),
                                      url = rep("-",10),
                                      icon = rep("http://pluspng.com/img-png/trollface-png-troll-face-png-image-19697-900.png",10),
                                      longitude= rnorm(10) - 122.5, #Hidden Field
                                      latitude = rnorm(10) + 47, #Hidden Field
                                      link = as.character(rep("<a href='http://www.google.com/'>fake link</a>",10))) #Hidden Field
      # my_icon<-makeIcon(
      #       iconUrl = "http://pluspng.com/img-png/trollface-png-troll-face-png-image-19697-900.png",
      #       iconWidth = 40, iconHeight = 40,
      #       iconAnchorX = 15, iconAnchorY = 15
      # )
        mydf <- reactive({
              my_addresses$data
        })
        
        observeEvent(input$add,{
            if (input$street!="-"||input$city!="-"){
                  currLatLong<- getLatLong(data.frame(street = input$street,
                                                          city = input$city,
                                                          state = input$state,
                                                          zip = input$zip))
                  cat(file=stderr(),"icon:",input$icon$datapath,"testing if length(input$icon$name)==0",length(input$icon$name)==0,"/n")
                  selectedIcon<-ifelse(length(input$icon$name)==0,
                                      "http://pluspng.com/img-png/trollface-png-troll-face-png-image-19697-900.png",
                                      input$icon$datapath)
                  new_row=data.frame(
                        label = input$label,
                        street = input$street,
                        city = input$city,
                        state = input$state,
                        zip = input$zip,
                        url = input$url,
                        icon = #"http://pluspng.com/img-png/trollface-png-troll-face-png-image-19697-900.png",
                              selectedIcon,
                        longitude=currLatLong[2],
                        latitude=currLatLong[1],
                        link=paste0("<a href='",patch_url(input$url),"'>",input$label,"</a>"))
            }
            my_addresses$data<-rbind(mydf(),new_row)
        })
        
        
        output$map <- renderLeaflet({
            leaflet() %>%
                  addTiles() %>%
                  addMarkers(data = select(mydf(),latitude,longitude), 
                             icon = makeIcon(iconUrl = mydf()$icon,
                                    iconWidth = 40, iconHeight = 40,
                                    iconAnchorX = 15, iconAnchorY = 15),
                             popup = mydf()$link,
                             clusterOptions = markerClusterOptions())
        })
        
        
        output$address_table<-renderDataTable(mydf())#select(mydf(),-c(longitude,latitude)))
      }

shinyApp(ui, server, options = list(height = 1300, width =1600))
```

